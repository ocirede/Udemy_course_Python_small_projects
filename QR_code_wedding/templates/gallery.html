<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Galeria de Fotos</title>
    <link rel="stylesheet" href="/static/css/styles_gallery.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" href="/static/images/AM.jpg" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body class="gallery_body">

<!-- LIGHTBOX -->
<div id="lightbox" class="lightbox hidden">
    <span class="close">&times;</span>
    <img id="lightbox-img">
    <a id="download-btn" download>
        <i class="fas fa-download"></i>
    </a>
</div>

<!-- MULTIPLE DOWNLOAD BUTTON -->
<button id="download-multiple" title="Download Selected">
    <i class="fas fa-download"></i>
</button>

<!-- GALLERY -->
<div class="gallery" id="gallery">
    {% for url in gallery_pics %}
    <div class="gallery-item">
        <img class="lazy" data-src="{{ url }}" data-full="{{ url }}" alt="Wedding photo">
        <input type="checkbox" class="select-img">
    </div>
    {% endfor %}
</div>

<!-- LOADING -->
<div id="loading-indicator">
    <i class="fas fa-spinner fa-spin"></i>
    {% if language == 'it' %}Caricando foto...{% else %}Cargando fotos...{% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const gallery = document.getElementById("gallery");
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightbox-img");
    const downloadBtn = document.getElementById("download-btn");
    const closeBtn = document.querySelector(".lightbox .close");
    const downloadMultipleBtn = document.getElementById("download-multiple");
    const loadingIndicator = document.getElementById("loading-indicator");

    let images = [];
    let currentIndex = 0;
    let nextCursor = "{{ next_cursor }}";
    let loading = false;
    let lastTap = 0; // needed for double-tap detection

    // ======================
    // LAZY LOAD
    // ======================
    const lazyObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if(entry.isIntersecting){
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.remove("lazy");
                lazyObserver.unobserve(img);
            }
        });
    });
    document.querySelectorAll(".gallery-item img.lazy").forEach(img => lazyObserver.observe(img));

    // ======================
    // REFRESH IMAGE ARRAY
    // ======================
    function refreshImages() {
        images = Array.from(document.querySelectorAll(".gallery-item img"))
                      .map(img => img.dataset.full);
    }

    // ======================
    // SHOW LIGHTBOX
    // ======================
    function showModalImage() {
        lightboxImg.src = images[currentIndex];
        const url = encodeURIComponent(images[currentIndex]);
        const filename = images[currentIndex].split("/").pop();
        downloadBtn.href = `/download?url=${url}`;
        downloadBtn.setAttribute("download", filename);
    }

    function closeLightbox() {
        lightbox.classList.add("hidden");
        lightboxImg.src = "";
        document.body.style.overflow = "";
    }

    closeBtn.onclick = closeLightbox;
    lightbox.addEventListener("click", e => { if(e.target === lightbox) closeLightbox(); });

    // ======================
    // MODAL SWIPE
    // ======================
    let touchStartX = 0;
    let touchEndX = 0;
    lightbox.addEventListener("touchstart", e => { touchStartX = e.changedTouches[0].screenX; });
    lightbox.addEventListener("touchend", e => {
        touchEndX = e.changedTouches[0].screenX;
        const delta = touchStartX - touchEndX;
        if(Math.abs(delta) > 50){
            if(delta > 0){
                currentIndex = (currentIndex + 1) % images.length;
            } else {
                currentIndex = (currentIndex - 1 + images.length) % images.length;
            }
            showModalImage();
        }
    });

    // Keyboard navigation
    document.addEventListener("keydown", e => {
        if(lightbox.classList.contains("hidden")) return;
        if(e.key === "ArrowRight"){
            currentIndex = (currentIndex + 1) % images.length;
            showModalImage();
        } else if(e.key === "ArrowLeft"){
            currentIndex = (currentIndex - 1 + images.length) % images.length;
            showModalImage();
        } else if(e.key === "Escape"){
            closeLightbox();
        }
    });

    // ======================
    // GALLERY CLICK & SELECTION
    // ======================
    function bindGalleryItem(wrapper) {
        const img = wrapper.querySelector("img");

        wrapper.addEventListener("click", () => {
            const now = Date.now();
            const tapGap = now - lastTap;
            lastTap = now;

           if (tapGap < 300) {
                // Double-tap → open modal
                wrapper.classList.remove("selected"); // Clear selection on double-tap
                refreshImages();
                currentIndex = images.indexOf(img.dataset.full);
                showModalImage();
                lightbox.classList.remove("hidden");
                document.body.style.overflow = "hidden";
                downloadMultipleBtn.style.display = "none";

                return;
            }

            // Single-tap → toggle selection
            wrapper.classList.toggle("selected");

            // Show/hide multiple download button
            const selectedCount = document.querySelectorAll(".gallery-item.selected").length;
            downloadMultipleBtn.style.display = selectedCount > 0 ? "flex" : "none";

        });
    }

    document.querySelectorAll(".gallery-item").forEach(bindGalleryItem);

    // ======================
    // MULTIPLE DOWNLOAD
    // ======================
    downloadMultipleBtn.addEventListener("click", () => {
        const selectedImgs = Array.from(document.querySelectorAll(".gallery-item.selected img"))
                                  .map(img => img.dataset.full);
        if(!selectedImgs.length){ alert("Select at least one image!"); return; }
        const query = selectedImgs.map(u => `url=${encodeURIComponent(u)}`).join("&");
        window.location.href = `/download_multiple?${query}`;
    });

    // ======================
    // INFINITE SCROLL
    // ======================
    async function loadMore() {
        if(!nextCursor || loading) return;

        loading = true;
        loadingIndicator.style.display = "block";

        try {
            const res = await fetch(`/gallery?cursor=${nextCursor}&ajax=1`);
            const data = await res.json();

            data.urls.forEach(url => {
                const wrapper = document.createElement("div");
                wrapper.className = "gallery-item";

                const img = document.createElement("img");
                img.className = "lazy";
                img.dataset.src = url;
                img.dataset.full = url;
                img.alt = "Wedding photo";

                wrapper.appendChild(img);
                gallery.appendChild(wrapper);

                lazyObserver.observe(img);
                bindGalleryItem(wrapper);
            });

            nextCursor = data.next_cursor;

        } catch(err) { console.error(err); }

        loadingIndicator.style.display = "none";
        loading = false;
    }

    window.addEventListener("scroll", () => {
        if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) loadMore();
    });
});
</script>
