<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wedding Gallery</title>
    <link rel="stylesheet" href="/static/css/styles_gallery.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>
<body class="gallery_body">

   <div class="gallery" id="gallery">
    {% for url in gallery_pics %}
        <a href="{{ url }}" target="_blank">
            <img class="lazy" data-src="{{ url }}" alt="Wedding photo">
        </a>
    {% endfor %}
</div>
   <div id="loading-indicator" style="display:none; text-align:center; padding:20px;">
       {% if language == 'it' %}
    <i class="fas fa-spinner fa-spin"></i>  Caricando foto...
       {% else %}
   <i class="fas fa-spinner fa-spin"></i>   Cargando fotos...
       {% endif %}

</div>

<script>
document.addEventListener("DOMContentLoaded", function() {

    // Lazy-load function
    const lazyload = (image) => {
        image.src = image.dataset.src || image.src;
        image.classList.remove("lazy");
    };

    // IntersectionObserver for lazy-loading
    const lazyImageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                lazyload(entry.target);
                observer.unobserve(entry.target);
            }
        });
    });

    // Observe existing lazy images
    const lazyImages = document.querySelectorAll("img.lazy");
    lazyImages.forEach(image => lazyImageObserver.observe(image));


    // ---------- Infinite scroll ----------
    let nextCursor = "{{ next_cursor }}";
    let loading = false;

    const gallery = document.getElementById("gallery");

    async function loadMore() {
        if (!nextCursor || loading) return;
        loading = true;
        document.getElementById("loading-indicator").style.display = "block";

        try {
            const res = await fetch(`/gallery?cursor=${nextCursor}&ajax=1`);
            const data = await res.json();

            data.urls.forEach(url => {
                const a = document.createElement("a");
                a.href = url;
                a.target = "_blank";

                const img = document.createElement("img");
                img.dataset.src = url;
                img.alt = "Wedding photo";
                img.classList.add("lazy");

                a.appendChild(img);
                gallery.appendChild(a);

                lazyImageObserver.observe(img);
            });

            nextCursor = data.next_cursor;

        } catch (err) {
            console.error("Error loading more images:", err);
        }
        document.getElementById("loading-indicator").style.display = "none";
        loading = false;
    }

    // Trigger load more on scroll
    window.addEventListener("scroll", () => {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
            loadMore();
        }
    });
});
</script>


</body>
</html>
